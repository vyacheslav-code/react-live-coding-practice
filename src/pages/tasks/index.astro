---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';

const allTasks = await getCollection('tasks');
const sortedTasks = allTasks.sort((a, b) => a.data.title.localeCompare(b.data.title));

// Extract unique tags and difficulties for filters
const allTags = [...new Set(allTasks.flatMap(task => task.data.tags))].sort();
const difficulties = ['easy', 'medium', 'hard'];

const difficultyColors = {
  easy: 'bg-green-600',
  medium: 'bg-yellow-600',
  hard: 'bg-red-600',
};

const difficultyBorderColors = {
  easy: 'border-green-600',
  medium: 'border-yellow-600',
  hard: 'border-red-600',
};
---

<BaseLayout title="Browse All Tasks - React Live Coding Practice" description="Explore all React coding challenges">
  <!-- Hero Section -->
  <div class="border-b border-gray-800 bg-gradient-to-b from-gray-900 to-black -mx-6 -mt-12">
    <div class="max-w-7xl mx-auto px-6 py-16 text-center">
      <h1 class="text-5xl font-bold text-white mb-4">
        Browse All Tasks
      </h1>
      <p class="text-xl text-gray-400 mb-8">
        {allTasks.length} React challenges to sharpen your skills
      </p>
      <a
        href="/tasks/random"
        class="inline-flex items-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors duration-200"
      >
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg>
        Random Task
      </a>
    </div>
  </div>

  <div class="mt-12">
    <!-- Filter Controls -->
    <div class="mb-8 space-y-4">
      <!-- Search Bar -->
      <div class="relative">
        <input
          type="text"
          id="search"
          placeholder="Search tasks..."
          class="w-full px-4 py-3 pl-12 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-blue-500 transition-colors"
        />
        <svg class="w-5 h-5 text-gray-500 absolute left-4 top-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>

      <!-- Filter Buttons -->
      <div class="flex flex-wrap gap-4">
        <!-- Difficulty Filter -->
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-400 font-medium">Difficulty:</span>
          <div class="flex gap-2">
            <button
              class="filter-difficulty px-3 py-1.5 text-sm font-medium rounded-md border border-gray-700 text-gray-300 hover:border-gray-600 transition-colors active"
              data-difficulty="all"
            >
              All
            </button>
            {difficulties.map((difficulty) => (
              <button
                class="filter-difficulty px-3 py-1.5 text-sm font-medium rounded-md border border-gray-700 text-gray-300 hover:border-gray-600 transition-colors"
                data-difficulty={difficulty}
              >
                {difficulty.charAt(0).toUpperCase() + difficulty.slice(1)}
              </button>
            ))}
          </div>
        </div>

        <!-- Tag Filter -->
        <div class="flex items-center gap-2">
          <span class="text-sm text-gray-400 font-medium">Tags:</span>
          <select
            id="tag-filter"
            class="px-3 py-1.5 text-sm font-medium bg-gray-800 border border-gray-700 rounded-md text-gray-300 focus:outline-none focus:border-blue-500 transition-colors"
          >
            <option value="all">All Tags</option>
            {allTags.map((tag) => (
              <option value={tag}>{tag}</option>
            ))}
          </select>
        </div>

        <!-- Clear Filters -->
        <button
          id="clear-filters"
          class="px-3 py-1.5 text-sm font-medium text-gray-400 hover:text-white transition-colors"
        >
          Clear Filters
        </button>
      </div>

      <!-- Results Count -->
      <div class="text-sm text-gray-400">
        Showing <span id="results-count">{allTasks.length}</span> of {allTasks.length} tasks
      </div>
    </div>

    <!-- Task Grid -->
    <div id="task-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {sortedTasks.map((task) => (
        <a
          href={`/tasks/${task.id}`}
          class="task-card group block bg-gray-900 border border-gray-800 rounded-lg p-6 hover:border-gray-700 hover:shadow-xl hover:shadow-blue-900/10 transition-all duration-200"
          data-difficulty={task.data.difficulty}
          data-tags={task.data.tags.join(',')}
          data-title={task.data.title.toLowerCase()}
          data-description={task.data.description.toLowerCase()}
        >
          <!-- Difficulty Badge -->
          <div class="mb-4">
            <span class={`inline-block px-2.5 py-1 rounded-md text-xs font-semibold text-white ${difficultyColors[task.data.difficulty]}`}>
              {task.data.difficulty.charAt(0).toUpperCase() + task.data.difficulty.slice(1)}
            </span>
          </div>

          <!-- Title -->
          <h3 class="text-xl font-semibold text-white mb-3 group-hover:text-blue-400 transition-colors">
            {task.data.title}
          </h3>

          <!-- Description Preview -->
          <p class="text-gray-400 text-sm mb-4 line-clamp-2">
            {task.data.description}
          </p>

          <!-- Tags -->
          <div class="flex flex-wrap gap-2 mb-4">
            {task.data.tags.slice(0, 3).map((tag) => (
              <span class="px-2 py-1 bg-gray-800 text-gray-300 rounded text-xs font-medium">
                {tag}
              </span>
            ))}
            {task.data.tags.length > 3 && (
              <span class="px-2 py-1 bg-gray-800 text-gray-400 rounded text-xs">
                +{task.data.tags.length - 3}
              </span>
            )}
          </div>

          <!-- Footer -->
          <div class="flex items-center justify-between pt-4 border-t border-gray-800">
            <div class="flex items-center text-gray-400 text-sm">
              <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              ~{task.data.timeEstimate} min
            </div>
            <div class="text-blue-500 text-sm font-medium group-hover:translate-x-1 transition-transform">
              Start â†’
            </div>
          </div>
        </a>
      ))}
    </div>

    <!-- No Results Message -->
    <div id="no-results" class="hidden text-center py-16">
      <div class="text-gray-500 text-lg mb-2">No tasks found</div>
      <p class="text-gray-600 text-sm">Try adjusting your filters</p>
    </div>
  </div>

  <script>
    // Filter functionality
    const searchInput = document.getElementById('search') as HTMLInputElement;
    const tagFilter = document.getElementById('tag-filter') as HTMLSelectElement;
    const clearFiltersBtn = document.getElementById('clear-filters') as HTMLButtonElement;
    const difficultyButtons = document.querySelectorAll('.filter-difficulty');
    const taskCards = document.querySelectorAll('.task-card');
    const resultsCount = document.getElementById('results-count') as HTMLSpanElement;
    const taskGrid = document.getElementById('task-grid') as HTMLDivElement;
    const noResults = document.getElementById('no-results') as HTMLDivElement;

    let activeFilters = {
      difficulty: 'all',
      tag: 'all',
      search: ''
    };

    function filterTasks() {
      let visibleCount = 0;

      taskCards.forEach((card) => {
        const element = card as HTMLElement;
        const difficulty = element.dataset.difficulty || '';
        const tags = (element.dataset.tags || '').split(',');
        const searchText = `${element.dataset.title} ${element.dataset.description}`;

        // Check difficulty filter
        const difficultyMatch = activeFilters.difficulty === 'all' || difficulty === activeFilters.difficulty;

        // Check tag filter
        const tagMatch = activeFilters.tag === 'all' || tags.includes(activeFilters.tag);

        // Check search filter
        const searchMatch = activeFilters.search === '' || searchText.includes(activeFilters.search.toLowerCase());

        // Show/hide card
        if (difficultyMatch && tagMatch && searchMatch) {
          element.classList.remove('hidden');
          visibleCount++;
        } else {
          element.classList.add('hidden');
        }
      });

      // Update results count
      resultsCount.textContent = visibleCount.toString();

      // Show/hide no results message
      if (visibleCount === 0) {
        taskGrid.classList.add('hidden');
        noResults.classList.remove('hidden');
      } else {
        taskGrid.classList.remove('hidden');
        noResults.classList.add('hidden');
      }
    }

    // Search input handler
    searchInput.addEventListener('input', (e) => {
      activeFilters.search = (e.target as HTMLInputElement).value;
      filterTasks();
    });

    // Tag filter handler
    tagFilter.addEventListener('change', (e) => {
      activeFilters.tag = (e.target as HTMLSelectElement).value;
      filterTasks();
    });

    // Difficulty filter handler
    difficultyButtons.forEach((button) => {
      button.addEventListener('click', () => {
        // Update active state
        difficultyButtons.forEach(btn => btn.classList.remove('active', 'bg-gray-700', 'border-gray-600'));
        button.classList.add('active', 'bg-gray-700', 'border-gray-600');

        // Update filter
        activeFilters.difficulty = (button as HTMLElement).dataset.difficulty || 'all';
        filterTasks();
      });
    });

    // Clear filters handler
    clearFiltersBtn.addEventListener('click', () => {
      // Reset filters
      activeFilters = {
        difficulty: 'all',
        tag: 'all',
        search: ''
      };

      // Reset UI
      searchInput.value = '';
      tagFilter.value = 'all';
      difficultyButtons.forEach(btn => btn.classList.remove('active', 'bg-gray-700', 'border-gray-600'));
      difficultyButtons[0].classList.add('active', 'bg-gray-700', 'border-gray-600');

      // Re-filter
      filterTasks();
    });
  </script>

  <style>
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</BaseLayout>
