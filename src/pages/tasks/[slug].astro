---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import TaskHeader from '../../components/TaskHeader.astro';
import CopyButton from '../../components/CopyButton';
import HintAccordion from '../../components/HintAccordion';

export async function getStaticPaths() {
  const tasks = await getCollection('tasks');
  return tasks.map((task) => ({
    params: { slug: task.id },
    props: { task },
  }));
}

const { task } = Astro.props;
const { Content } = await task.render();

// Get all tasks sorted by slug for navigation
const allTasks = await getCollection('tasks');
const sortedTasks = allTasks.sort((a, b) => a.id.localeCompare(b.id));
const currentIndex = sortedTasks.findIndex((t) => t.id === task.id);

const prevSlug = currentIndex > 0 ? sortedTasks[currentIndex - 1].id : undefined;
const nextSlug = currentIndex < sortedTasks.length - 1 ? sortedTasks[currentIndex + 1].id : undefined;

const difficultyColors = {
  easy: 'text-emerald-400 border-emerald-400/30',
  medium: 'text-amber-400 border-amber-400/30',
  hard: 'text-rose-400 border-rose-400/30',
};
---

<BaseLayout title={`${task.data.title} - React Live Coding Practice`} description={task.data.description}>
  <TaskHeader currentSlug={task.id} prevSlug={prevSlug} nextSlug={nextSlug} />

  <main class="max-w-4xl mx-auto">
    <!-- Hero Section -->
    <div class="mb-16">
      <h1 class="text-5xl font-bold tracking-tight mb-6 leading-tight">{task.data.title}</h1>

      <div class="flex flex-wrap items-center gap-3 mb-6">
        <span class={`px-3 py-1 rounded-md text-xs font-medium border ${difficultyColors[task.data.difficulty]} bg-transparent`}>
          {task.data.difficulty.charAt(0).toUpperCase() + task.data.difficulty.slice(1)}
        </span>
        <span class="flex items-center gap-1.5 px-3 py-1 rounded-md text-xs font-medium border border-neutral-800 text-neutral-400 bg-transparent">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          {task.data.timeEstimate} min
        </span>
        {task.data.tags.map((tag) => (
          <span class="px-3 py-1 rounded-md text-xs font-medium border border-neutral-800 text-neutral-400 bg-transparent">
            {tag}
          </span>
        ))}
      </div>

      <p class="text-lg text-neutral-400 leading-relaxed">{task.data.description}</p>
    </div>

    <!-- Learning Goals -->
    <section class="mb-12 border border-neutral-800 rounded-lg p-8">
      <h2 class="text-xl font-semibold mb-4 tracking-tight">Learning Goals</h2>
      <ul class="space-y-3 text-neutral-400">
        {task.data.learningGoals.map((goal) => (
          <li class="flex items-start gap-3">
            <svg class="w-5 h-5 mt-0.5 text-neutral-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
            <span>{goal}</span>
          </li>
        ))}
      </ul>
    </section>

    <!-- Task Description -->
    <section class="mb-12 border border-neutral-800 rounded-lg p-8">
      <h2 class="text-xl font-semibold mb-4 tracking-tight">Task Description</h2>
      <div class="prose prose-invert prose-neutral max-w-none text-neutral-400 prose-headings:text-white prose-headings:font-semibold prose-headings:tracking-tight prose-p:leading-relaxed prose-li:text-neutral-400 prose-code:text-neutral-300 prose-code:bg-neutral-900 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded prose-code:text-sm prose-code:font-normal prose-code:before:content-[''] prose-code:after:content-['']">
        <Content />
      </div>
    </section>

    <!-- Hints -->
    <section class="mb-12">
      <HintAccordion hints={task.data.hints} client:load />
    </section>

    <!-- Starter Code -->
    <section class="border border-neutral-800 rounded-lg overflow-hidden">
      <div class="flex justify-between items-center px-8 py-5 border-b border-neutral-800">
        <h2 class="text-xl font-semibold tracking-tight">Starter Code</h2>
        <CopyButton code={task.data.starterCode} client:load />
      </div>
      <div class="bg-black border-t border-neutral-800">
        <pre class="p-6 overflow-x-auto text-sm leading-relaxed"><code class="language-tsx">{task.data.starterCode}</code></pre>
      </div>
    </section>
  </main>
</BaseLayout>
